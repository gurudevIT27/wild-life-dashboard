<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wild Vision Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #202938 0, #05070c 45%, #020308 100%);
      color: #f9fafb;
      min-height: 100vh;
      padding: 24px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.04em;
      margin-bottom: 20px;
    }

    /* TOP LAYOUT: three horizontal cards */
    .grid-top {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) minmax(0, 1.1fr); /* Live | Alerts | Map */
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: linear-gradient(145deg, #101624, #05070d);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.12);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    /* Live feed */
    .live-image-wrapper {
      margin-top: 8px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      min-height: 360px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .live-image-wrapper img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .live-placeholder {
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      padding: 32px;
    }

    /* Alerts */
    .alerts-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 380px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .alert-item {
      display: flex;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 64, 175, 0.6));
      border: 1px solid rgba(148, 163, 184, 0.3);
      align-items: flex-start;
    }
    .alert-icon {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .alert-icon-fire { background: rgba(248, 113, 113, 0.18); }
    .alert-icon-animal { background: rgba(59, 130, 246, 0.18); }
    .alert-icon-human { background: rgba(52, 211, 153, 0.18); }
    .alert-icon-poach { background: rgba(244, 114, 182, 0.18); }
    .alert-main { flex: 1; }
    .alert-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
    .alert-meta { font-size: 11px; color: #9ca3af; }
    .alert-tag {
      font-size: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
      align-self: center;
    }
    .alert-empty {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 10px;
    }

    /* Map */
    #map {
      margin-top: 12px;
      width: 100%;
      height: 260px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      overflow: hidden;
    }
    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
    }

    /* Stack vertically on small screens */
    @media (max-width: 900px) {
      .grid-top { grid-template-columns: 1fr; }
    }

    /* small helper styles */
    .controls { display:flex; gap:8px; align-items:center; }
    .status-online { color: #34d399; font-weight:600; }
    .status-offline { color: #f87171; font-weight:600; }
    .btn-clear { background: transparent; border: 1px solid rgba(148,163,184,0.12); padding:6px 8px; color:#cbd5e1; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="page-title">Wild Vision Dashboard</div>

  <!-- HORIZONTAL: Live feed + Alerts + Map -->
  <div class="grid-top">
    <!-- Live feed -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Live Feed</span>
      </div>
      <div class="live-image-wrapper">
        <img src="{% url 'video_feed' %}" alt="Live Stream"
             onerror="showLivePlaceholder()" id="live-image">
        <div class="live-placeholder" id="live-placeholder" style="display:none;">
          Waiting for camera stream...<br />
          Make sure your webcam/device is connected.
        </div>
      </div>
    </div>

    <!-- Alerts -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Alerts</span>
        <div class="controls">
          <div style="font-size: 11px; color: #9ca3af;" id="alerts-count">0</div>
          <div id="status-indicator" style="font-size:11px;color:#9ca3af;">
            Status: <span id="online-status" class="status-offline">Unknown</span>
          </div>
        </div>
      </div>
      <div id="alerts-list" class="alerts-list"></div>
      <div class="alert-empty" id="alerts-empty" style="display:none;">
        No recent alerts in the last 30 minutes.
      </div>
    </div>

    <!-- Map -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Map</span>
        <span style="font-size: 11px; color: #9ca3af;">Latest detections</span>
      </div>
      <div id="map"></div>
      <div class="footer-note">
        Markers show last known location per detected class.
      </div>
    </div>
  </div>

  <script>
    /* ---------- Live feed fallback ---------- */
    function showLivePlaceholder() {
      const img = document.getElementById("live-image");
      const ph = document.getElementById("live-placeholder");
      if (img) img.style.display = "none";
      if (ph) ph.style.display = "block";
    }

    /* ---------- Alerts ---------- */
    function classIconAndClass(className) {
      const lower = (className || "").toLowerCase();
      if (lower.includes("fire")) return { emoji: "ðŸ”¥", cls: "alert-icon alert-icon-fire" };
      if (lower.includes("poach")) return { emoji: "âš ï¸", cls: "alert-icon alert-icon-poach" };
      if (lower.includes("human") || lower.includes("person")) return { emoji: "ðŸ§", cls: "alert-icon alert-icon-human" };
      if (lower.includes("animal")) return { emoji: "ðŸ¾", cls: "alert-icon alert-icon-animal" };
      return { emoji: "â—", cls: "alert-icon alert-icon-animal" };
    }

    function setOnlineStatus(val) {
      const el = document.getElementById('online-status');
      if (val) {
        el.textContent = 'Online';
        el.className = 'status-online';
      } else {
        el.textContent = 'Offline';
        el.className = 'status-offline';
      }
    }

    function renderAlerts(data) {
      const listEl = document.getElementById("alerts-list");
      const emptyEl = document.getElementById("alerts-empty");
      const countEl = document.getElementById("alerts-count");
      listEl.innerHTML = "";

      if (!data || data.length === 0) {
        emptyEl.style.display = "block";
        countEl.textContent = "0";
        return;
      } else {
        emptyEl.style.display = "none";
      }

      countEl.textContent = data.length.toString();

      data.forEach(doc => {
        const ts = doc.timestamp || "";
        const loc = doc.location || {};
        const dets = doc.detections || [];
        const firstDet = dets[0] || {};
        const cls = firstDet["class"] || doc.class_name || doc.class || "Unknown";
        const conf = firstDet["confidence"] || doc.confidence || null;

        const iconInfo = classIconAndClass(cls);

        const item = document.createElement("div");
        item.className = "alert-item";

        const iconSpan = document.createElement("div");
        iconSpan.className = iconInfo.cls;
        iconSpan.textContent = iconInfo.emoji;

        const main = document.createElement("div");
        main.className = "alert-main";

        const title = document.createElement("div");
        title.className = "alert-title";
        title.textContent = cls.charAt(0).toUpperCase() + cls.slice(1);

        const meta = document.createElement("div");
        meta.className = "alert-meta";
        const tsText = ts ? ts.replace("T", " ").slice(0, 19) : "";
        const gpsText = (loc.lat !== undefined && loc.lng !== undefined)
          ? ` | GPS: ${loc.lat}, ${loc.lng}` : "";
        const confText = conf != null ? ` | ${(conf * 100).toFixed(1)}%` : "";
        meta.textContent = `${tsText}${gpsText}${confText}`;

        main.appendChild(title);
        main.appendChild(meta);

        const tag = document.createElement("div");
        tag.className = "alert-tag";
        tag.textContent = "AUTO";

        item.appendChild(iconSpan);
        item.appendChild(main);
        item.appendChild(tag);
        listEl.appendChild(item);
      });
    }

    async function fetchAlerts() {
      try {
        const res = await fetch("{% url 'latest_alerts' %}", { cache: "no-store" });
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        renderAlerts(data);
        setOnlineStatus(true);
      } catch (err) {
        console.error("Error fetching alerts", err);
        setOnlineStatus(false);
      }
    }

    /* ---------- Google Map + locations ---------- */
    let map;
    let markers = [];

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    async function fetchLocations() {
      try {
        const res = await fetch("{% url 'latest_locations' %}", { cache: "no-store" });
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        updateMapMarkers(data);
      } catch (err) {
        console.error("Error fetching locations", err);
      }
    }

    function updateMapMarkers(data) {
      if (!map) return;
      clearMarkers();

      if (!Array.isArray(data)) return;

      data.forEach(item => {
        const latest = item.latest || item;
        const loc = latest.location || {};
        if (loc.lat === undefined || loc.lng === undefined) return;

        const cls = item._id || latest.class || "Detection";
        const marker = new google.maps.Marker({
          position: { lat: Number(loc.lat), lng: Number(loc.lng) },
          map,
          title: cls
        });
        const infow = new google.maps.InfoWindow({
          content: `<div style="color:#111;padding:6px;">${cls}<br/><small>${latest.timestamp || ''}</small></div>`
        });
        marker.addListener("click", () => infow.open(map, marker));
        markers.push(marker);
      });

      if (markers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(m => bounds.extend(m.getPosition()));
        map.fitBounds(bounds);
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 12.9716, lng: 77.5946 },
        zoom: 8,
      });
      fetchLocations();
      setInterval(fetchLocations, 15000);
    }

    /* ---------- Start polling ---------- */
    fetchAlerts();
    setInterval(fetchAlerts, 10000);
  </script>

  <!-- Google Maps JS API with your key -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgeN41rd63kACP7lIgmj4yVDYz6d9P5E8&callback=initMap">
  </script>
</body>
</html>
